{% extends 'base.html.twig' %}

{% block title %}Advanced Form Demo - htmx-bundle{% endblock %}

{% block body %}
<div class="mb-6">
    <h1 class="text-3xl font-bold">HtmxTypeExtension Demo</h1>
    <p class="text-base-content/70">This demo showcases the <code class="badge badge-ghost">htmx</code> option available on all Symfony form fields via HtmxTypeExtension.</p>
</div>

<div id="form-wrapper">
    {{ block('formContent') }}
</div>
{% endblock %}

{% block formContent %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    {# Left Column - Form #}
    <div class="space-y-6">
        {{ form_start(form, {
            'attr': {
                'hx-post': path('app_advanced_form'),
                'hx-target': '#form-wrapper',
                'hx-swap': 'innerHTML',
                'autocomplete': 'off',
                'novalidate': 'novalidate',
            }
        }) }}

        {% if not form.vars.valid and form.vars.submitted %}
        <div class="alert alert-error shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Please fix the validation errors below.</span>
        </div>
        {% endif %}

        {# Section 1: Live Search / Autocomplete #}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <span class="badge badge-primary">1</span>
                    Live Search / Autocomplete
                </h2>
                <p class="text-sm text-base-content/70 mb-4">Type at least 2 characters to search users. Uses <code class="badge badge-ghost badge-sm">hx-trigger</code> with delay and condition.</p>
                <p class="text-xs text-base-content/50 mb-4">Try: <span class="badge badge-outline badge-xs">john</span> <span class="badge badge-outline badge-xs">jane</span> <span class="badge badge-outline badge-xs">alice</span> <span class="badge badge-outline badge-xs">bob</span> <span class="badge badge-outline badge-xs">@example</span></p>

                <div class="form-control w-full relative">
                    <label class="label">
                        <span class="label-text">{{ form_label(form.user) }}</span>
                        <span id="search-spinner" class="htmx-indicator">
                            <span class="loading loading-spinner loading-xs"></span>
                        </span>
                    </label>
                    {{ form_widget(form.user, {'attr': {'class': 'input input-bordered w-full' ~ (form_errors(form.user)|length > 0 ? ' input-error' : '')}}) }}
                    {% if form_errors(form.user)|length > 0 %}
                    <label class="label py-1">
                        <span class="label-text-alt text-error">{{ form_errors(form.user) }}</span>
                    </label>
                    {% endif %}
                    <div id="user-results" class="absolute top-full left-0 right-0 z-10 mt-1"></div>
                </div>

                <div class="mt-2 text-xs text-base-content/50">
                    <strong>htmx options:</strong> get, trigger, target, indicator, params, on::before-request
                </div>
            </div>
        </div>

        {# Section 2: Cascading Selects #}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <span class="badge badge-primary">2</span>
                    Cascading Selects
                </h2>
                <p class="text-sm text-base-content/70 mb-4">Select a country to load cities dynamically. Uses <code class="badge badge-ghost badge-sm">hx-on::config-request</code> to modify the URL.</p>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">{{ form_label(form.country) }}</span>
                        </label>
                        {{ form_widget(form.country, {'attr': {'class': 'select select-bordered w-full' ~ (form_errors(form.country)|length > 0 ? ' select-error' : '')}}) }}
                        {% if form_errors(form.country)|length > 0 %}
                        <label class="label py-1">
                            <span class="label-text-alt text-error">{{ form_errors(form.country) }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <div class="form-control w-full" id="city-select-wrapper">
                        {% if cities is defined and cities|length > 0 %}
                            {{ block('citySelect') }}
                            {% if form_errors(form.city)|length > 0 %}
                            <label class="label py-1">
                                <span class="label-text-alt text-error">{{ form_errors(form.city) }}</span>
                            </label>
                            {% endif %}
                        {% else %}
                            <label class="label">
                                <span class="label-text">{{ form_label(form.city) }}</span>
                            </label>
                            <select name="form[city]" id="form_city" class="select select-bordered w-full" disabled>
                                <option value="">Select a country first</option>
                            </select>
                            {% do form.city.setRendered() %}
                        {% endif %}
                    </div>
                </div>

                <div class="mt-2 text-xs text-base-content/50">
                    <strong>htmx options:</strong> get, trigger, target, on::config-request
                </div>
            </div>
        </div>

        {# Section 3: Inline Validation #}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <span class="badge badge-primary">3</span>
                    Inline Validation
                </h2>
                <p class="text-sm text-base-content/70 mb-4">Fields validate on blur. Server-side validation without full form submit.</p>

                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">{{ form_label(form.email) }}</span>
                    </label>
                    {{ form_widget(form.email, {'attr': {'class': 'input input-bordered w-full'}}) }}
                    <div id="email-validation" class="min-h-[24px]">
                        {% if form_errors(form.email)|length > 0 %}
                            <label class="label py-1">
                                <span class="label-text-alt text-error">{{ form_errors(form.email) }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ form_label(form.username) }}</span>
                    </label>
                    {{ form_widget(form.username, {'attr': {'class': 'input input-bordered w-full'}}) }}
                    <div id="username-validation" class="min-h-[24px]">
                        {% if form_errors(form.username)|length > 0 %}
                            <label class="label py-1">
                                <span class="label-text-alt text-error">{{ form_errors(form.username) }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-2 text-xs text-base-content/50">
                    <strong>htmx options:</strong> post, trigger, target, swap
                </div>
            </div>
        </div>

        {# Section 4: Conditional Fields with BusinessFieldsType #}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <span class="badge badge-primary">4</span>
                    Conditional Fields
                </h2>
                <p class="text-sm text-base-content/70 mb-4">Select account type to show/hide additional fields. Uses <code class="badge badge-ghost badge-sm">conditional</code> option from <code class="badge badge-ghost badge-sm">ConditionalTypeExtension</code>.</p>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">{{ form_label(form.accountType) }}</span>
                    </label>
                    {# ConditionalTypeExtension adds htmx directly to each radio input #}
                    <div class="flex gap-4" id="{{ form.accountType.vars.id }}">
                        {% for child in form.accountType %}
                            <label class="label cursor-pointer gap-2">
                                {{ form_widget(child, {'attr': {'class': 'radio radio-primary'}}) }}
                                <span class="label-text">{{ child.vars.label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                {# Conditional field wrapper - ID set by ConditionalTypeExtension #}
                <div id="{{ form.business.vars.conditional.wrapper_id|default('business-fields') }}" class="mt-4">
                    {{ block('businessFields') }}
                </div>

                <div class="mt-2 text-xs text-base-content/50">
                    <strong>conditional:</strong> trigger, endpoint (auto-configures htmx)
                </div>
            </div>
        </div>

        {# Submit #}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <span class="badge badge-primary">5</span>
                    Form Submit
                </h2>
                <p class="text-sm text-base-content/70 mb-4">The entire form submits via htmx using form_start attributes.</p>

                <div class="flex items-center gap-2">
                    {{ form_widget(form.submit) }}
                    <span class="htmx-indicator">
                        <span class="loading loading-spinner loading-sm"></span>
                    </span>
                </div>
            </div>
        </div>

        {{ form_end(form, {'render_rest': false}) }}
    </div>

    {# Right Column - Code Examples #}
    <div class="space-y-6">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">HtmxTypeExtension Usage</h2>
                <p class="text-sm text-base-content/70 mb-4">Add htmx attributes to any form field using the <code class="badge badge-ghost badge-sm">htmx</code> option:</p>

                <div class="mockup-code text-xs">
                    <pre><code class="language-php">$builder->add('search', TextType::class, [
    'htmx' => [
        'get' => '/search',
        'trigger' => 'keyup changed delay:300ms',
        'target' => '#results',
        'indicator' => '#spinner',
    ],
]);</code></pre>
                </div>

                <h3 class="font-semibold mt-4 mb-2">Supported Options</h3>
                <div class="overflow-x-auto">
                    <table class="table table-xs">
                        <thead>
                            <tr>
                                <th>Option</th>
                                <th>Attribute</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>get</td><td>hx-get</td></tr>
                            <tr><td>post</td><td>hx-post</td></tr>
                            <tr><td>trigger</td><td>hx-trigger</td></tr>
                            <tr><td>target</td><td>hx-target</td></tr>
                            <tr><td>swap</td><td>hx-swap</td></tr>
                            <tr><td>indicator</td><td>hx-indicator</td></tr>
                            <tr><td>include</td><td>hx-include</td></tr>
                            <tr><td>vals</td><td>hx-vals</td></tr>
                            <tr><td>confirm</td><td>hx-confirm</td></tr>
                            <tr><td>on::{event}</td><td>hx-on::{event}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Event Handlers</h2>
                <p class="text-sm text-base-content/70 mb-4">Use <code class="badge badge-ghost badge-sm">on::{event}</code> for htmx event handlers:</p>

                <div class="mockup-code text-xs">
                    <pre><code class="language-php">'htmx' => [
    'get' => '/cities/__VALUE__',
    'on::config-request' => "event.detail.path =
        event.detail.path.replace('__VALUE__', this.value)",
]</code></pre>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Conditional Fields</h2>
                <p class="text-sm text-base-content/70 mb-4">Use <code class="badge badge-ghost badge-sm">conditional</code> to show/hide fields based on another field's value:</p>

                <div class="mockup-code text-xs">
                    <pre><code class="language-php">$builder
    ->add('accountType', ChoiceType::class, [
        'choices' => ['Personal' => 'personal', 'Business' => 'business'],
        'expanded' => true,
    ])
    ->add('business', BusinessFieldsType::class, [
        'conditional' => [
            'trigger' => 'accountType',
            'endpoint' => '/form/business-fields',
        ],
    ]);</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block searchResults %}
{% if results is defined and results|length > 0 %}
<ul class="menu bg-base-200 rounded-box shadow-lg">
    {% for user in results %}
    <li>
        <a href="#" onclick="document.querySelector('[name=\'form[user]\']').value = '{{ user.name }}'; this.closest('ul').remove(); return false;">
            <div>
                <div class="font-medium">{{ user.name }}</div>
                <div class="text-xs text-base-content/50">{{ user.email }}</div>
            </div>
        </a>
    </li>
    {% endfor %}
</ul>
{% elseif results is defined %}
<div class="bg-base-200 rounded-box p-3 text-sm text-base-content/70">
    No users found
</div>
{% endif %}
{% endblock %}

{% block citySelect %}
{% set selectedCity = form is defined and form.city is defined ? form.city.vars.value : null %}
<label class="label">
    <span class="label-text">City</span>
</label>
<select name="form[city]" id="form_city" class="select select-bordered w-full{% if form is defined and form.city is defined and form_errors(form.city)|length > 0 %} select-error{% endif %}" {% if cities is not defined or cities is empty %}disabled{% endif %}>
    {% if cities is defined and cities|length > 0 %}
        <option value="">Select a city...</option>
        {% for code, name in cities %}
            <option value="{{ code }}"{% if selectedCity == code %} selected{% endif %}>{{ name }}</option>
        {% endfor %}
    {% else %}
        <option value="">Select a country first</option>
    {% endif %}
</select>
{% endblock %}

{% block fieldValidation %}
{% if errors is defined and errors|length > 0 %}
<label class="label py-1">
    <span class="label-text-alt text-error flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        {{ errors|first }}
    </span>
</label>
{% elseif isValid is defined and isValid %}
<label class="label py-1">
    <span class="label-text-alt text-success flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Valid
    </span>
</label>
{% endif %}
{% endblock %}

{% block businessFields %}
{# Determine if we should show business fields #}
{% set showBusiness = isBusiness is defined ? isBusiness : (form is defined and form.accountType is defined and form.accountType.vars.value == 'business') %}
{% set businessForm = businessForm is defined ? businessForm : (form is defined and form.business is defined ? form.business : null) %}

{% if showBusiness and businessForm %}
<div class="space-y-4 p-4 bg-base-200 rounded-lg">
    <div class="text-sm font-semibold text-primary">Business Account Fields</div>

    <div class="form-control w-full">
        <label class="label">
            <span class="label-text">{{ form_label(businessForm.companyName) }}</span>
        </label>
        {{ form_widget(businessForm.companyName, {'attr': {'class': 'input input-bordered w-full' ~ (form_errors(businessForm.companyName)|length > 0 ? ' input-error' : '')}}) }}
        <div id="companyName-validation" class="min-h-[24px]">
            {% if form_errors(businessForm.companyName)|length > 0 %}
            <label class="label py-1">
                <span class="label-text-alt text-error">{{ form_errors(businessForm.companyName) }}</span>
            </label>
            {% endif %}
        </div>
    </div>

    <div class="form-control w-full">
        <label class="label">
            <span class="label-text">{{ form_label(businessForm.taxId) }}</span>
        </label>
        {{ form_widget(businessForm.taxId, {'attr': {'class': 'input input-bordered w-full' ~ (form_errors(businessForm.taxId)|length > 0 ? ' input-error' : '')}}) }}
        <div id="taxId-validation" class="min-h-[24px]">
            {% if form_errors(businessForm.taxId)|length > 0 %}
            <label class="label py-1">
                <span class="label-text-alt text-error">{{ form_errors(businessForm.taxId) }}</span>
            </label>
            {% endif %}
        </div>
    </div>

    <div class="form-control w-full">
        <label class="label">
            <span class="label-text">{{ form_label(businessForm.companyAddress) }}</span>
        </label>
        {{ form_widget(businessForm.companyAddress, {'attr': {'class': 'textarea textarea-bordered w-full' ~ (form_errors(businessForm.companyAddress)|length > 0 ? ' textarea-error' : '')}}) }}
        {% if form_errors(businessForm.companyAddress)|length > 0 %}
        <label class="label py-1">
            <span class="label-text-alt text-error">{{ form_errors(businessForm.companyAddress) }}</span>
        </label>
        {% endif %}
    </div>
</div>
{% elseif showBusiness %}
{# Fallback for htmx partial when businessForm comes from standalone form #}
<div class="space-y-4 p-4 bg-base-200 rounded-lg">
    <div class="text-sm font-semibold text-primary">Business Account Fields</div>
    <p class="text-sm text-base-content/70">Loading...</p>
</div>
{% else %}
<div class="p-4 bg-base-200 rounded-lg text-sm text-base-content/70">
    <span class="badge badge-ghost">Personal</span> account selected - no additional fields required.
</div>
{% if form is defined and form.business is defined %}
    {% do form.business.setRendered() %}
{% endif %}
{% endif %}
{% endblock %}

{% block submitSuccess %}
<div class="card bg-success text-success-content shadow-xl">
    <div class="card-body">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Form Submitted Successfully!
        </h2>

        <div class="mt-4">
            <h3 class="font-semibold mb-2">Submitted Data:</h3>
            <div class="bg-success-content/10 rounded-lg p-4">
                <pre class="text-sm whitespace-pre-wrap">{{ data|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
            </div>
        </div>

        <div class="card-actions justify-end mt-4">
            <button class="btn btn-outline"
                    hx-get="{{ path('app_advanced_form') }}"
                    hx-target="#form-wrapper"
                    hx-swap="innerHTML">
                Submit Another
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block sourceCode %}
{% include '_source_code.html.twig' with {controller: 'AdvancedFormController.php', template: 'advanced_form.html.twig'} %}
{% endblock %}
