{% extends 'demo.html.twig' %}

{% set demo_title = 'HtmxTypeExtension Demo' %}
{% set demo_description = 'This demo showcases the htmx option available on all Symfony form fields via HtmxTypeExtension.' %}
{% set demo_controller = 'AdvancedFormController.php' %}
{% set demo_template = '_demo/advanced_form.html.twig' %}

{% use '_demo/advanced_form.html.twig' %}
{% set demo_csrf = true %}

{% block demo_styles %}
<style>
    .user-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 10;
        margin-top: 0.25rem;
    }
    .user-results ul {
        margin: 0;
        padding: 0;
        list-style: none;
        background: var(--pico-card-background-color);
        border: 1px solid var(--pico-muted-border-color);
        border-radius: var(--pico-border-radius);
    }
    .user-results li {
        padding: 0;
    }
    .user-results a {
        display: block;
        padding: 0.5rem 1rem;
        text-decoration: none;
    }
    .user-results a:hover {
        background: var(--pico-primary-background);
    }
    .field-relative {
        position: relative;
    }
    /* Inline validation messages */
    .validation-message {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    .validation-error {
        color: var(--pico-del-color);
    }
    .validation-success {
        color: var(--pico-ins-color);
    }

    /* Symfony form errors */
    .form-error-message,
    ul.form-errors li,
    .invalid-feedback,
    form ul:not([class]) li,
    form .help-block {
        color: var(--pico-del-color);
        font-size: 0.875rem;
    }
    ul.form-errors,
    form ul:not([class]) {
        list-style: none;
        padding: 0;
        margin: 0.25rem 0 0 0;
    }

    /* Invalid input styling */
    input:invalid,
    select:invalid,
    textarea:invalid,
    input[aria-invalid="true"],
    select[aria-invalid="true"],
    textarea[aria-invalid="true"],
    .is-invalid input,
    .is-invalid select,
    .is-invalid textarea {
        border-color: var(--pico-del-color);
    }
    input:invalid:focus,
    select:invalid:focus,
    textarea:invalid:focus {
        border-color: var(--pico-del-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--pico-del-color), 0.25);
    }
    .business-fields {
        padding: 1rem;
        background: var(--pico-card-sectionning-background-color);
        border-radius: var(--pico-border-radius);
        margin-top: 1rem;
    }
    .code-example {
        background: var(--pico-card-sectionning-background-color);
        padding: 1rem;
        border-radius: var(--pico-border-radius);
        overflow-x: auto;
        font-size: 0.8rem;
    }
    .code-example pre {
        margin: 0;
        white-space: pre-wrap;
    }

    /* Error alert */
    .alert-error {
        background: var(--pico-del-color);
        color: var(--pico-background-color);
        padding: 1rem;
        border-radius: var(--pico-border-radius);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block demo_header %}
<p><small>Powered by <mark>PicoCSS</mark> + <mark>htmx</mark></small></p>
{% endblock %}

{% block demo %}
{{ block('_main') }}
{% endblock %}

{% block demo_scripts %}
<script>
    function markInvalidFields() {
        // Find all error lists from Symfony form rendering
        document.querySelectorAll('ul.form-errors, .help-block.text-danger, li.form-error').forEach(function(errorEl) {
            // Find the closest input/select/textarea
            const container = errorEl.closest('.mb-3, div');
            if (container) {
                const input = container.querySelector('input, select, textarea');
                if (input) {
                    input.setAttribute('aria-invalid', 'true');
                }
            }
        });

        // Also check for Symfony's default error rendering (ul inside form row)
        document.querySelectorAll('form ul:not(.user-results ul)').forEach(function(ul) {
            if (ul.textContent.trim() && !ul.classList.contains('user-results')) {
                const container = ul.closest('div');
                if (container) {
                    const input = container.querySelector('input, select, textarea');
                    if (input && ul.querySelector('li')) {
                        input.setAttribute('aria-invalid', 'true');
                        ul.classList.add('form-errors');
                    }
                }
            }
        });
    }

    // Run on page load
    markInvalidFields();

    // Run after htmx swaps
    document.body.addEventListener('htmx:afterSwap', markInvalidFields);
</script>
{% endblock %}
